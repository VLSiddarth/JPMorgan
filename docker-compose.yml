version: "3.9"

# ============================================================================
# JPMorgan European Equity Dashboard - Docker Stack
# - Streamlit APP (frontend)
# - FastAPI API
# - WebSocket real-time server
# - MongoDB (documents)
# - TimescaleDB/Postgres (time series)
# - Redis (cache)
# - Prometheus & Grafana (monitoring)
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Streamlit Frontend
  # --------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jpm_app
    command: >
      streamlit run app.py
      --server.address=0.0.0.0
      --server.port=8501
    ports:
      - "8501:8501"
    env_file:
      - .env
    depends_on:
      - api
      - mongodb
      - timescale
      - redis
    networks:
      - jpmnet
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # FastAPI Backend
  # --------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jpm_api
    command: >
      uvicorn api:app
      --host 0.0.0.0
      --port 8000
      --workers 4
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      - mongodb
      - timescale
      - redis
    networks:
      - jpmnet
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # WebSocket Real-time Market Data Server
  # --------------------------------------------------------------------------
  websocket:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jpm_ws
    command: >
      python websocket_server.py
    env_file:
      - .env
    depends_on:
      - api
    networks:
      - jpmnet
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # MongoDB - Document Store (signals, configs, portfolios, logs, etc.)
  # --------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0
    container_name: jpm_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: jpm_dashboard
      # For local dev only; use secrets in production
      MONGO_INITDB_ROOT_USERNAME: jpm_user
      MONGO_INITDB_ROOT_PASSWORD: jpm_password
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - jpmnet

  # --------------------------------------------------------------------------
  # TimescaleDB (Postgres) - Time Series Storage
  # --------------------------------------------------------------------------
  timescale:
    image: timescale/timescaledb:latest-pg16
    container_name: jpm_timescale
    restart: unless-stopped
    environment:
      POSTGRES_DB: jpm_timeseries
      POSTGRES_USER: jpm_user
      POSTGRES_PASSWORD: jpm_password
      # Optional tuning for Timescale
      TIMESCALEDB_TELEMETRY: "off"
    ports:
      - "5432:5432"
    volumes:
      - timescale_data:/var/lib/postgresql/data
    networks:
      - jpmnet

  # --------------------------------------------------------------------------
  # Redis - Caching Layer
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: jpm_redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"
    networks:
      - jpmnet

  # --------------------------------------------------------------------------
  # Prometheus - Metrics Scraping
  # --------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: jpm_prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    networks:
      - jpmnet
    depends_on:
      - app
      - api

  # --------------------------------------------------------------------------
  # Grafana - Dashboards (App, API, DB metrics)
  # --------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: jpm_grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      # You can map provisioning here if you want auto-dashboards
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana_dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - jpmnet

# -----------------------------------------------------------------------------
# Networks & Volumes
# -----------------------------------------------------------------------------
networks:
  jpmnet:
    driver: bridge

volumes:
  mongo_data:
  timescale_data:
  grafana_data:
